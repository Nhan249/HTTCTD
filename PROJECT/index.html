<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Irrigation System</title>
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px; min-height: 100vh;
        }
        .container {max-width: 1200px; margin: 0 auto;}
        .header {background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);}
        h1 {color: #333; font-size: 2em; margin-bottom: 10px;}
        .subtitle {color: #666; margin-bottom: 10px;}
        .last-update {color: #999; font-size: 0.9em;}
        .dashboard {display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;}
        .card {background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);}
        .card h2 {color: #667eea; margin-bottom: 15px; font-size: 1.3em;}
        .value {font-size: 3em; font-weight: bold; color: #333; margin: 15px 0;}
        .progress-bar {width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin: 15px 0;}
        .progress-fill {height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.5s ease;}
        .status {display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-top: 10px;}
        .status-on {background: #4caf50; color: white;}
        .status-off {background: #999; color: white;}
        .status-warning {background: #ff9800; color: white;}
        .btn {padding: 15px 30px; border: none; border-radius: 10px; font-size: 1em; font-weight: bold; cursor: pointer; width: 100%; margin: 5px 0; transition: all 0.3s;}
        .btn-on {background: #4caf50; color: white;}
        .btn-off {background: #f44336; color: white;}
        .btn:hover:not(:disabled) {transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3);}
        .btn:disabled {opacity: 0.5; cursor: not-allowed;}
        .info-row {display: flex; justify-content: space-between; padding: 10px; background: #f5f5f5; border-radius: 8px; margin: 8px 0;}
        .toggle-container {display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #e3f2fd; border-radius: 8px; margin-top: 15px;}
        .toggle-switch {position: relative; width: 60px; height: 30px; background: #ccc; border-radius: 15px; cursor: pointer; transition: background 0.3s;}
        .toggle-switch.active {background: #4caf50;}
        .toggle-slider {position: absolute; width: 26px; height: 26px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: left 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}
        .toggle-switch.active .toggle-slider {left: 32px;}
        .system-status {display: grid; gap: 15px;}
        .status-item {display: flex; justify-content: space-between; align-items: center; padding: 15px; border-radius: 10px; background: linear-gradient(90deg, #f0f0f0, #e0e0e0);}
        .status-badge {padding: 5px 15px; border-radius: 15px; font-size: 0.85em; font-weight: bold;}
        @media (max-width: 768px) {.dashboard {grid-template-columns: 1fr;} h1 {font-size: 1.5em;} .value {font-size: 2em;}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå± H·ªá Th·ªëng T∆∞·ªõi N∆∞·ªõc T·ª± ƒê·ªông</h1>
            <p class="subtitle">Gi√°m s√°t v√† ƒëi·ªÅu khi·ªÉn th√¥ng minh</p>
            <p class="last-update">C·∫≠p nh·∫≠t: <span id="lastUpdate">--:--:--</span></p>
        </div>

        <div class="dashboard">
            <!-- Soil Moisture Card -->
            <div class="card">
                <h2>üíß ƒê·ªô ·∫®m ƒê·∫•t</h2>
                <div class="value"><span id="soilMoisture">--</span>%</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="moistureBar" style="width: 0%"></div>
                </div>
                <div class="status" id="moistureStatus">--</div>
                <div class="info-row">
                    <span>Ng∆∞·ª°ng t∆∞·ªõi:</span>
                    <strong>40% - 70%</strong>
                </div>
            </div>

            <!-- Pump Control Card -->
            <div class="card">
                <h2>‚ö° ƒêi·ªÅu Khi·ªÉn M√°y B∆°m</h2>
                <div class="status" id="pumpStatus">T·∫ÆT</div>
                <button class="btn btn-on" id="pumpBtn" onclick="togglePump()">B·∫¨T M√ÅY B∆†M</button>

                <div class="toggle-container">
                    <span><strong>Ch·∫ø ƒë·ªô t·ª± ƒë·ªông:</strong></span>
                    <div class="toggle-switch" id="autoToggle" onclick="toggleAutoMode()">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="card">
            <h2>üîß Tr·∫°ng Th√°i H·ªá Th·ªëng</h2>
            <div class="system-status">
                <div class="status-item">
                    <span>C·∫£m bi·∫øn ƒë·ªô ·∫©m</span>
                    <span class="status-badge status-on">Ho·∫°t ƒë·ªông</span>
                </div>
                <div class="status-item">
                    <span>K·∫øt n·ªëi ESP32</span>
                    <span class="status-badge status-on" id="espStatus">ƒê√£ k·∫øt n·ªëi</span>
                </div>
                <div class="status-item">
                    <span>Relay m√°y b∆°m</span>
                    <span class="status-badge" id="relayStatus">T·∫Øt</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoMode = true;
        let pumpStatus = false;
        let isConnected = false;

        function fetchData() {
            fetch('/api/sensor-data')
                .then(resp => { if (!resp.ok) throw new Error('Network error'); return resp.json(); })
                .then(data => { updateDashboard(data); if (!isConnected) setConnected(true); })
                .catch(err => { console.error(err); if (isConnected) setConnected(false); });
        }

        function setConnected(connected) {
            isConnected = connected;
            let esp = document.getElementById('espStatus');
            esp.textContent = connected ? 'ƒê√£ k·∫øt n·ªëi' : 'M·∫•t k·∫øt n·ªëi';
            esp.className = 'status-badge ' + (connected ? 'status-on' : 'status-off');
        }

        function updateDashboard(data) {
            // Soil moisture
            document.getElementById('soilMoisture').textContent = data.soilMoisture.toFixed(1);
            document.getElementById('moistureBar').style.width = data.soilMoisture + '%';
            let moistureStatus = data.soilMoisture < 30 ? 'KH√î' : data.soilMoisture < 60 ? 'TRUNG B√åNH' : '·∫®M';
            let moistureClass = data.soilMoisture < 30 ? 'status-off' : data.soilMoisture < 60 ? 'status-warning' : 'status-on';
            let msEl = document.getElementById('moistureStatus');
            msEl.textContent = moistureStatus; msEl.className = 'status ' + moistureClass;

            // Pump
            pumpStatus = data.pumpStatus;
            let pumpEl = document.getElementById('pumpStatus');
            pumpEl.textContent = pumpStatus ? 'B·∫¨T' : 'T·∫ÆT';
            pumpEl.className = 'status ' + (pumpStatus ? 'status-on' : 'status-off');

            let btn = document.getElementById('pumpBtn');
            btn.textContent = pumpStatus ? 'T·∫ÆT M√ÅY B∆†M' : 'B·∫¨T M√ÅY B∆†M';
            btn.className = 'btn ' + (pumpStatus ? 'btn-off' : 'btn-on');
            btn.disabled = autoMode;

            document.getElementById('relayStatus').textContent = pumpStatus ? 'B·∫≠t' : 'T·∫Øt';
            document.getElementById('relayStatus').className = 'status-badge ' + (pumpStatus ? 'status-on' : 'status-off');

            autoMode = data.autoMode;
            let toggle = document.getElementById('autoToggle');
            if (autoMode) toggle.classList.add('active'); else toggle.classList.remove('active');

            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('vi-VN');
        }

        function togglePump() {
            if (autoMode) return alert('Vui l√≤ng t·∫Øt ch·∫ø ƒë·ªô t·ª± ƒë·ªông tr∆∞·ªõc!');
            fetch('/api/control-pump', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({pumpStatus:!pumpStatus})})
                .then(()=>setTimeout(fetchData,500)).catch(console.error);
        }

        function toggleAutoMode() {
            autoMode = !autoMode;
            fetch('/api/auto-mode', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({autoMode})})
                .then(()=>setTimeout(fetchData,500)).catch(console.error);
        }

        fetchData(); setInterval(fetchData,2000);
        setInterval(()=>{ if(!isConnected) fetchData(); },5000);
    </script>
</body>
</html>
